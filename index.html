<html>
<head>
<title>PROJECT 2</title>
<script src="scripts/d3.js"></script>

<style>
@import
url('https://fonts.googleapis.com/css?family=Raleway:300,400,700,900');

*{
    transition: all ease-in-out 550ms;
}

body{
  background-color: #C6F1E7;
  font-family: 'Raleway', sans-serif;
}

h1{
  display: inline-block;
  vertical-align: middle;

  font-size:5em;
}

#trendHeading{
	color:white;
	text-align:center;
}

#trend{
	color:white;
}


#title{
  width: 80%;
  height: auto;
  margin: auto;

}

#marriage, #main{

 	padding: 1em;
 	border: solid 1px;
 	display: inline-block;
 	margin: 0 auto;
 	background-color:black;
}

#main {
  background-color: rgb(255, 255, 255, 0.5);
  border: none;
}

#info{

 	padding: 1em;
 	border: solid 1px;
 	background-color:black;
}

#two{
	display: inline-block;

	width:460px;
	height:500px;
	vertical-align:top;
}

.yaxis line{
	stroke:red;
}

.yaxis path{
  stroke: red;
}

.yaxis text{
  fill: red;
}

.mainAxis {
  font-size: 13px;
}

</style>
</head>
<body>
	<div id="title" align="center">
		<h1>Lyrics in Popular Songs in the English Language.</h1>
		<p> Analyzing lyrics in the top 100 Billboard songs and their prevalence in the top words of the English language. </p>
	</div>
	<div class="center" align="center">
		<svg id="main" width='90%' height='800' align="center"></svg>
	</div>
	<div class="center" align="center">
	   <svg id="marriage" width='800' height='470'></svg>
  	<div id="two">
  		<h3 id = "trendHeading"> trend 0 </h3>
  		<p id = "trend"> explanation 0</p>
  	</div>
	</div>
	<script>

  function simpleSlider () {

      var width = 100,
          value = 0.5, /* Domain assumes to be [0 - 1] */
          event,
          x = 0,
          y = 0;

      function slider (selection) {

          //Line to represent the current value
          var valueLine = selection.append("line")
              .attr("x1", x)
              .attr("x2", x + (width * value))
              .attr("y1", y)
              .attr("y2", y)
              .style({stroke: "#51CB3F",
                      "stroke-linecap": "round",
                      "stroke-width": 6 });

          //Line to show the remaining value
          var emptyLine = selection.append("line")
              .attr("x1", x + (width * value))
              .attr("x2", x + width)
              .attr("y1", y)
              .attr("y2", y)
              .style({
                  "stroke": "#ECECEC",
                  "stroke-linecap": "round",
                  "stroke-width": 6
              });

          var drag = d3.drag().on("drag", function() {
              var newX = d3.mouse(this)[0];

              if (newX < x)
                  newX = x;
              else if (newX > x + width)
                  newX = x + width;

              value = (newX - x) / width;
              valueCircle.attr("cx", newX);
              valueLine.attr("x2", x + (width * value));
              emptyLine.attr("x1", x + (width * value));

              if (event)
                  event();

              // d3.event.sourceEvent.stopPropagation();
          })

          //Draggable circle to represent the current value
          var valueCircle = selection.append("circle")
              .attr("cx", x + (width * value))
              .attr("cy", y)
              .attr("r", 8)
              .style({
                  "stroke": "black",
                  "stroke-width": 1.0,
                  "fill": "white"
              })
              .call(drag);
      }

      slider.x = function (val) { x = val; return slider; }
      slider.y = function (val) { y = val; return slider; }
      slider.value = function (val) {
          if (val) {
              value = val;
              return slider;
          } else {
              return value;
          }
      }
      slider.width = function (val) { width = val; return slider; }
      slider.event = function (val) { event = val;  return slider; }
      return slider;
  }

  function parseLine (line) {
    var wordArray = line["Lyrics"].split(" ");
    var dict = {};
    wordArray.forEach(function (d)  {
      if (dict[d] == undefined) {
        dict[d] = 1;
      } else {
        dict[d] = dict[d] + 1;
      }
    });
    return {
      Rank: Number(line["Rank"]),
      Title: line["Song"],
      Artist: line["Artist"],
      Year: Number(line["Year"]),
      Lyrics: dict
    };
  }

  var topWords = [];
  d3.text("top1000.txt", function(data) {
    var topWordsPrelim = d3.csvParseRows(data);
    topWordsPrelim.forEach(function (wordArray) {
      topWords.push(wordArray[0]);
    });
  });

  var graphHeight = document.getElementById("main").clientHeight;
  var graphWidth = document.getElementById("main").clientWidth;
  var axisPadding = 50;
  var currentYear = "2012";
  var nWords = 1000;

  var mainsvg = d3.select("#main"),
  g = mainsvg.append("g").attr("transform", "translate(" + 0 + "," + axisPadding  + ")"),
  slider1 = new simpleSlider();
  slider1.width(200).x(30).y(200).value(1.0).event(function(){
        console.log(slider1.value());
    });
  // mainsvg.call(slider1);

  mainsvg.append("text")
  .attr("id", "SongName")
  .attr("x", 300)
  .attr("y", 500)
  .style("font-size", "24pt");

  var xScaleMain = d3.scaleLinear()
  .domain([1, 100])
  .range([axisPadding, graphWidth - axisPadding]);

  var yScaleMain = d3.scaleLinear()
  .domain([0, 1])
  .range([graphHeight - axisPadding * 2, axisPadding * 2]);

  mainsvg.append("g")
    .attr("transform", "translate(" + axisPadding / 2  + ", " + 0  + ")")
    .attr("class", "mainAxis")
    .call(YAxis);

  mainsvg.append("g")
  .attr("transform", "translate(0, " + (graphHeight - axisPadding * 2) + ")")
  .attr("class", "mainAxis")
  .call(XAxis);

  function XAxis(g) {
    g.call(d3.axisTop(xScaleMain));
    g.select(".domain").remove();
  }

  function YAxis(g) {
    g.call(d3.axisLeft(yScaleMain));
    g.select(".domain").remove();
    g.selectAll(".tick:not(:first-of-type) line")
    .attr("stroke", "#777")
    .attr("stroke-dasharray", "3, 8")
    .attr("x1", graphWidth - axisPadding * 2)
    .attr("x2", -axisPadding / 2);
    g.selectAll(".tick text")
    .attr("x", 4)
    .attr("dy", -4);
  }

  function isYear(year) {
      return year.Year === currentYear;
  }

  d3.csv("billboard_lyrics_1964-2017.csv", parseLine, function (error, data) {

    rawData = data;

    nestedData = d3.nest()
    .key(function (d) { return d.Year; })
    .entries(data);

    yearData = nestedData.map(function (year) {
      var result = { Year: year.key, Songs: year.values };

      return result;
    });

    var topNWords = topWords.slice(0, nWords);
    var selectedYear = yearData.find(isYear);
    var yearSongs = selectedYear.Songs;
    yearSongs.forEach(function(s) {
      var songLyrics = Object.keys(s.Lyrics);
      var totalWords = 0;
      var uniqueWords = songLyrics.length;
      var uniqueInTop = 0;
      var totalInTop = 0;
      songLyrics.forEach(function(word) {
        totalWords += s.Lyrics[word];
        if (topNWords.includes(word)) {
          uniqueInTop++;
          totalInTop += s.Lyrics[word];
        }
      });
      var uniqueRatio = uniqueInTop / uniqueWords;
      console.log(totalInTop + " / "+ totalWords);
      var totalRatio = totalInTop / totalWords;
      mainsvg.append("circle")
      .attr("cx", xScaleMain(s.Rank))
      .attr("cy", yScaleMain(uniqueRatio))
      .attr("r", 10)
      .style("opacity", 0.3)
      .on("mouseover", function () {
        mainsvg.select("#SongName").text(s.Title);
      });
      mainsvg.append("circle")
      .attr("cx", xScaleMain(s.Rank))
      .attr("cy", yScaleMain(totalRatio))
      .attr("r", 10)
      .style("fill", "purple")
      .style("opacity", 0.3)
      .on("mouseover", function () {
        mainsvg.select("#SongName").text(s.Title);
      });
    });
  });

	d3.csv("words.csv", function(data) {
		data.forEach(function(d) {
			d.year = +d.year;
		});
		var svg = d3.select("#marriage");
		var xScale = d3.scaleLinear()
		.domain([1960, 2014])
		.range([30, 790]);

		var color = ["#9B30FF","#3399ff","#00ff7f","#ffff66","#ffa700","#ff6666"];

		var decade = ["sixty","seventy","eighty","ninety","thousands","tens"];

		var rects = ["first","second","third","fourth","fifth","sixth"];

		var count = 0;
		for (var i = 0; i < data.length; i++){
			count = i%10;
			svg.append("text")
				.attr("text-anchor","middle")
				.attr("x",10+xScale(data[i].year))
				.attr("y",80 + 40*count)
				.attr("font-size",30)
				.attr("fill",color[Math.floor(i/10)])
				.attr("class",decade[Math.floor(i/10)])
				.attr("fill-opacity",0.2)
				.text(data[i].word);
				//.attr("fill-opacity",(1 - (30 + 40*count) / (30 + 40*9) * .85 + .15))
		}

		for(i = 0; i < 6; i++){
			svg.append("rect").attr("width", 800/6)
			.attr("height", 470)
			.attr("opacity",0)
			.attr("class",rects[i])
			.attr("x", 10+xScale(1960 + (i*10))-(400/6))
			.attr("y", 0);
		}

		var first = Array.from(document.querySelectorAll('svg .first'));
		var second = Array.from(document.querySelectorAll('svg .second'));
		var third = Array.from(document.querySelectorAll('svg .third'));
		var fourth = Array.from(document.querySelectorAll('svg .fourth'));
		var fifth = Array.from(document.querySelectorAll('svg .fifth'));
		var sixth = Array.from(document.querySelectorAll('svg .sixth'));



		first.forEach(function(el){
			//console.log(el);
			el.addEventListener("mouseover", change60s);
			el.addEventListener("mouseout", StopChange60s);
		})

		function change60s(e){
  			d3.selectAll(".sixty").attr("fill-opacity",1);
  			document.body.style.backgroundColor = color[0];
  			trendHeading.innerText = "trend 1";
  			trend.innerText = "explanation 1";
		}

		function StopChange60s(e){
  			d3.selectAll(".sixty").attr("fill-opacity",.2);
		}

		second.forEach(function(el){
			//console.log(el);
			el.addEventListener("mouseover", change70s);
			el.addEventListener("mouseout", StopChange70s);
		})

		function change70s(e){
  			d3.selectAll(".seventy").attr("fill-opacity",1);
  			document.body.style.backgroundColor = color[1];
  			trendHeading.innerText = "trend 2";
  			trend.innerText = "explanation 2";
		}

		function StopChange70s(e){
  			d3.selectAll(".seventy").attr("fill-opacity",.2);
		}

		third.forEach(function(el){
			//console.log(el);
			el.addEventListener("mouseover", change80s);
			el.addEventListener("mouseout", StopChange80s);
		})

		function change80s(e){
  			d3.selectAll(".eighty").attr("fill-opacity",1);
  			document.body.style.backgroundColor = color[2];
  			trendHeading.innerText = "trend 3";
  			trend.innerText = "explanation 3";

		}

		function StopChange80s(e){
  			d3.selectAll(".eighty").attr("fill-opacity",.2);
		}

		fourth.forEach(function(el){
			//console.log(el);
			el.addEventListener("mouseover", change90s);
			el.addEventListener("mouseout", StopChange90s);
		})

		function change90s(e){
  			d3.selectAll(".ninety").attr("fill-opacity",1);
  			document.body.style.backgroundColor = color[3];
  			trendHeading.innerText = "trend 4";
  			trend.innerText = "explanation 4";
		}

		function StopChange90s(e){
  			d3.selectAll(".ninety").attr("fill-opacity",.2);
		}

		fifth.forEach(function(el){
			//console.log(el);
			el.addEventListener("mouseover", change00s);
			el.addEventListener("mouseout", StopChange00s);
		})

		function change00s(e){
  			d3.selectAll(".thousands").attr("fill-opacity",1);
  			document.body.style.backgroundColor = color[4];
  			trendHeading.innerText = "trend 5";
  			trend.innerText = "explanation 5";
		}

		function StopChange00s(e){
  			d3.selectAll(".thousands").attr("fill-opacity",.2);
		}

		sixth.forEach(function(el){
			//console.log(el);
			el.addEventListener("mouseover", change10s);
			el.addEventListener("mouseout", StopChange10s);
		})

		function change10s(e){
  			d3.selectAll(".tens").attr("fill-opacity",1);
  			document.body.style.backgroundColor = color[5];
  			trendHeading.innerText = "trend 6";
  			trend.innerText = "explanation 6";
		}

		function StopChange10s(e){
  			d3.selectAll(".tens").attr("fill-opacity",.2);
		}

	});

	d3.csv("us-marriages-divorces-1867-2014.csv", function(data) {
  		data.forEach(function(d) {
    	d.Year = +d.Year;
    	d.Marriages_per_1000 = +d.Marriages_per_1000;
    	d.Divorces_per_1000 = +d.Divorces_per_1000;

  		});
  		console.log(data[0]);

  		var xScale = d3.scaleLinear()
		.domain([1960, 2014])
		.range([30, 790]);

		var yScale = d3.scaleLinear()
		.domain([0.0, 17.0])
		.range([470.0, 30.0]);

		var MarriageLineGenerator = d3.line()
    	.x(function(d) { return xScale(d.Year); })
    	.y(function(d) { return yScale(d.Marriages_per_1000); })
    	.curve(d3.curveMonotoneX)

    	var DivorceLineGenerator = d3.line()
    	.x(function(d) { return xScale(d.Year); })
    	.y(function(d) { return yScale(d.Divorces_per_1000); })
    	.curve(d3.curveMonotoneX)

		var svg = d3.select("#marriage");

		svg.append("g")
    	.attr("class", "yaxis")
    	.call(d3.axisLeft(yScale));

  	svg.append("g")
    .attr("class","yaxis")
    .call(d3.axisBottom(xScale));

		svg.append("path")
    	.datum(data)
    	.attr("class", "line")
    	.attr("stroke","#11CBD7")
    	.attr("stroke-width",5)
    	.attr("fill","none")
    	.attr("d", MarriageLineGenerator);

    	svg.append("path")
    	.datum(data)
    	.attr("class", "line")
    	.attr("stroke","#FA4659")
    	.attr("stroke-width",5)
    	.attr("fill","none")
    	.attr("d", DivorceLineGenerator);
	});

	</script>

</body>
</html>
