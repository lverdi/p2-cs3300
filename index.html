<html>
<head>
<title>PROJECT 2</title>
<script src="scripts/d3.js"></script>
<script src="scripts/jquery.js"></script>

<style>
@font-face { font-family: "Raleway"; src: url("fonts/Raleway-Regular.ttf")}

*{
    transition: all ease-in-out 550ms;
}

body {
  background-color: #25274D;
  font-family: 'Raleway', sans-serif;
  color: #AAABB8;
}

h1 {
  display: inline-block;
  vertical-align: middle;
  font-size:5em;
}

circle {
  transition: opacity 600ms;
}

#title {
  width: 80%;
  height: auto;
  margin: auto;
  font-size: 20px;
}

#yearDisplay {
  color: #AAABB8;
  font-size: 24px;
  margin-left: 46%;
}

#yearDisplay span {
  color: #2E9CCA;
  font-size: 32px;
}

#searchBar {
  margin-left: 25%;
  height: 40px;
  width: 15%;
  background: #AAABB8;
  font-size: 20px;
  font-family: 'Raleway', sans-serif;
  border: none;
  padding-left: 5px;
}

#main {
 	padding: 1em;
  border: none;
 	display: inline-block;
 	margin: 0 auto;
  background-color: #464866;
}

#info {
  padding: 1em;
  border: none;
 	display: inline-block;
 	margin: 30px auto;
  background-color: #464866;
}

.toolbar {
  display: flex;
  align-items: center;
}

.mainAxis {
  font-size: 15px;
  color: white;
  font-family: 'Raleway', sans-serif;
}

.slidecontainer {
    width: 100%;
}

.slider {
    -webkit-appearance: none;
    height: 25px;
    background: #29648A;
    outline: none;
    opacity: 0.7;
    -webkit-transition: .2s;
    transition: opacity .2s;
}

.slider:hover {
    opacity: 1;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    border-radius:25px;
    width: 25px;
    height: 25px;
    background: #38c4ff ;
    cursor: pointer;
}

.slider::-moz-range-thumb {
    border-radius:25px;
    width: 25px;
    height: 25px;
    background: #38c4ff;
    cursor: pointer;
}

</style>
</head>
<body>
	<div id="title" align="center">
		<h1>Lyrics in Popular Songs in the English Language.</h1>
		<p> Analyzing lyrics in the top 100 Billboard songs and their prevalence in the top words of the English language. <br>
        You can move the slider to select top 100 songs from a year, or search for a word to see where it appears in the data.</p>
	</div>
	<div class="center" align="center">
    <div class="toolbar">
      <h3 id="yearDisplay"> Year: <span>2017</span></h3>
      <input id="searchBar" type="text" placeholder="Search for a word">
    </div>
      <div class = "slidercontainter">
        <input class = "slider" id="slider2" type="range" min="0" max="52" value="52"/>
      </div>

		<svg id="main" width='90%' height='750' align="center"></svg>
    <svg id="info" width='80%' height='600' align="center"></svg>

	</div>

	</div>
	<script>

  function parseLine (line) {
    var wordArray = line["Lyrics"].split(" ");
    var dict = {};
    for (var i = 0; i < wordArray.length; i++) {
      if (dict[wordArray[i]] == undefined) {
        dict[wordArray[i]] = 1;
      } else {
        dict[wordArray[i]] = dict[wordArray[i]] + 1;
      }
    }
    return {
      Rank: Number(line["Rank"]),
      Title: line["Song"],
      Artist: line["Artist"],
      Year: Number(line["Year"]),
      Lyrics: dict
    };
  }

  var topWords = [];
  d3.text("top1000.txt", function(data) {
    var topWordsPrelim = d3.csvParseRows(data);
    for (var i = 0; i < topWordsPrelim.length; i++) {
      topWords.push(topWordsPrelim[i][0]);
    }
  });

  var graphHeight = document.getElementById("main").clientHeight;
  var graphWidth = document.getElementById("main").clientWidth;
  var infoHeight = document.getElementById("info").clientHeight;
  var infoWidth = document.getElementById("info").clientWidth;
  var axisPadding = 40;
  var currentYear = "2017";
  var nWords = 500;
  var points = [];
  var wordPoints = [];
  var circles;
  var nestedData;

  var mainsvg = d3.select("#main"),
  g = mainsvg.append("g").attr("transform", "translate(" + 0 + "," + axisPadding  + ")");
  var infosvg = d3.select("#info");

  document.getElementById("slider2").style.width = graphWidth;

  mainsvg.append("text")
  .attr("id", "SongName")
  .attr("x", graphWidth / 2)
  .attr("y", graphHeight / 10)
  .attr("text-anchor", "middle")
  .attr("fill", "#AAABB8")
  .style("font-size", "30pt");

  mainsvg.append("text")
  .attr("id", "loading")
  .attr("x", graphWidth / 2)
  .attr("y", graphHeight / 2)
  .attr("text-anchor", "middle")
  .attr("fill", "#AAABB8")
  .style("font-size", "40pt")
  .style("opacity", "1")
  .text("Loading...");

  infosvg.append("text")
  .attr("id", "placeholderInfo")
  .attr("x", infoWidth / 2)
  .attr("y", infoHeight / 2)
  .attr("text-anchor", "middle")
  .attr("fill", "#AAABB8")
  .style("font-size", "30pt")
  .style("opacity", "1")
  .text("Click on a song to get more details");

  var xScaleMain = d3.scaleLinear()
  .domain([1, 100])
  .range([axisPadding, graphWidth - axisPadding]);

  var yScaleMain = d3.scaleLinear()
  .domain([15, 90])
  .range([graphHeight - axisPadding, axisPadding]);

  var rScaleTiers = d3.scaleLinear()
  .domain([1, 70])
  .range([4.5, 8.5]);

  var fillScale = d3.scaleLinear().domain([0, 1, 2, 3, 4, 5]).range(["#FEFFFF", "#090977", "#9f0aad", "#ff269c", "#05b27b", "#f73636"]);
  var inverseFillScale = d3.scaleLinear().domain([0, 1, 2, 3, 4, 5]).range(["#090977", "#FEFFFF", "#FEFFFF", "#FEFFFF", "#FEFFFF", "#FEFFFF"]);

  mainsvg.append("g")
  .attr("transform", "translate(" + axisPadding / 2  + ", " + 0  + ")")
  .attr("class", "mainAxis")
  .style("opacity", "0")
  .call(YAxis);

  mainsvg.append("g")
  .attr("transform", "translate(0, " + (graphHeight - axisPadding * 2) + ")")
  .attr("class", "mainAxis")
  .style("opacity", "0")
  .call(XAxis);

  function XAxis(g) {
    g.call(d3.axisTop(xScaleMain));
    g.select(".domain").remove();
    g.selectAll(".tick text")
    .attr("fill", "#AAABB8");
  }

  function YAxis(g) {
    g.call(d3.axisLeft(yScaleMain));
    g.select(".domain").remove();
    g.selectAll(".tick:not(:first-of-type) line")
    .attr("stroke", "#AAABB8")
    .attr("stroke-dasharray", "3, 8")
    .attr("x1", graphWidth - axisPadding * 2)
    .attr("x2", -axisPadding / 2);
    g.selectAll(".tick text")
    .attr("fill", "#AAABB8")
    .attr("x", 4)
    .attr("dy", -4);
  }

  function isYear(year) {
      return year.Year === currentYear;
  }

  d3.csv("billboard_lyrics_1964-2017.csv", parseLine, function (error, data) {

    rawData = data;

    nestedData = d3.nest()
    .key(function (d) { return d.Year; })
    .entries(data);

    yearData = nestedData.map(function (year) {
      var result = { Year: year.key, Songs: year.values };
      return result;
    });
    showPointsForYear();
  });

  var slider2 = document.getElementById("slider2");
      slider2.oninput = function () {
        total = parseInt(slider2.value) + 1965;
        currentYear = (total).toString();
        document.getElementById("yearDisplay").innerHTML = "Year: <span>" + currentYear + "</span>";
      };
      slider2.onchange = function () {
        wordPoints = [];
        points = [];
        d3.selectAll("circle").remove();
        document.getElementById("searchBar").value = "";
        total = parseInt(slider2.value) + 1965;
        currentYear = (total).toString();
        document.getElementById("yearDisplay").innerHTML = "Year: <span>" + currentYear + "</span>";
        showPointsForYear();
      };

  var search = document.getElementById("searchBar");
      search.oninput = function () {
        var input = search.value.toLowerCase();
        var pts = d3.selectAll(".wordTiers");
        var songpts = d3.selectAll(".songbubbles");
        if (input == "") {
          pts.style("opacity", 0.9);
          songpts.style("opacity", 0.25);
          songpts.style("fill", "white");
        } else {
          pts.style("opacity", 0.2);
          songpts.style("opacity", 0.15);
          songpts.style("fill", "white");
          var searchResults = [];
          var selectedYear = yearData.find(isYear);
          var yearSongs = selectedYear.Songs;
          var topNWords = topWords.slice(0, nWords);
          for (var i = 0; i < yearSongs.length; i++) {
            var s = yearSongs[i];
            var songLyrics = Object.keys(s.Lyrics);
            for (var j = 0; j < songLyrics.length; j++) {
              var lyric = songLyrics[j];
              if (lyric.includes(input)) {
                document.getElementById("song" + s.Rank).style.fill = "#3399ff";
                document.getElementById("song" + s.Rank).style.opacity = 0.8;
                var idx = topNWords.indexOf(lyric);
                if (idx != -1) {
                  var tier = Math.floor(idx / 100);
                  document.getElementById("tier" + tier + "-" + s.Rank).style.opacity = 1;
                }
              }
            }
          }
        }
      };

  function updateDisplay() {
    circles
    .attr("cx", function(d) { return d.x; })
    .attr("cy", function(d) { return d.y; });
   }

  function showPointsForYear() {
    var topNWords = topWords.slice(0, nWords);
    var selectedYear = yearData.find(isYear);
    var yearSongs = selectedYear.Songs;
    for (var i = 0; i < yearSongs.length; i++) {
      var s = yearSongs[i];
      var tierList = [0, 0, 0, 0, 0, 0];
      var tierWords = [[], [], [], [], [], []];
      var songLyrics = Object.keys(s.Lyrics);
      var totalWords = 0;
      var uniqueWords = songLyrics.length;
      var uniqueInTop = 0;
      var totalInTop = 0;
      for (var j = 0; j < songLyrics.length; j++) {
        var word = songLyrics[j];
        totalWords += s.Lyrics[word];
        var idx = topNWords.indexOf(word);
        if (idx != -1) {
          tierList[Math.floor(idx / 100)] += s.Lyrics[word];
          tierWords[Math.floor(idx / 100)].push(word);
          uniqueInTop++;
          totalInTop += s.Lyrics[word];
        } else {
          tierList[5] += s.Lyrics[word];
          tierWords[5].push(word);
        }
      }
      var uniqueRatio = 100 * uniqueInTop / uniqueWords;
      var totalRatio = 100 * totalInTop / totalWords;

      for (var k = 0; k < tierList.length - 1; k++) {
        if (tierList[k] != 0) {
          wordPoints.push({
            "rank": s.Rank,
            "title": s.Title,
            "artist": s.Artist,
            "r": rScaleTiers(tierList[k]),
            "total": totalRatio,
            "unique": uniqueRatio,
            "tier": k
          });
        }
      }

      points.push({
        "rank": s.Rank,
        "total": totalRatio,
        "totalInTop": totalInTop,
        "wordCount": totalWords,
        "unique": uniqueRatio,
        "title": s.Title,
        "artist": s.Artist,
        "tiers": tierList,
        "words": tierWords
      });
    }

    for (var k = 0; k < points.length; k++) {
      var current = points[k];
      var add = 35;
      if (current.totalInTop <= 50) {
        add = 80;
      }
      mainsvg.append("circle")
      .attr("id", "song" + current.rank)
      .attr("class", "songbubbles")
      .attr("r", rScaleTiers(current.totalInTop + add))
      .attr("cx", xScaleMain(current.rank))
      .attr("cy", yScaleMain(Math.max(current.total, 15)))
      .style("fill", "white")
      .style("opacity", 0.25);
    }

    circles = mainsvg.selectAll(".wordTiers").data(wordPoints).enter().append("circle")
    .attr("id", function (d) { return "tier" + d.tier + "-" + d.rank; })
    .attr("r", function (d) { return d.r; })
    .attr("cx", function (d) { return xScaleMain(d.rank); })
    .attr("cy", yScaleMain(50))
    .attr("class", "wordTiers")
    .style("fill", function (d) { return fillScale(d.tier); })
    .style("opacity", 0.9)
    .on("mouseover", function (d) {
      mainsvg.select("#SongName").text("#" + d.rank + " " + d.title.toUpperCase() + " - " + capFirstWord(d.artist));
    });

    $(".wordTiers").click(function(event) {
      event.preventDefault();

      $("body, html").animate({
        scrollTop: $("#info").offset().top
      }, 400, 'linear');
    });

    circles.on("click", function (d) {
      d3.selectAll("#info > *").remove();
      var infosvg = d3.select('#info');
      var selected = points.find(function (s) {
          return s.rank === d.rank;
      });
      d3.select("#info").style("background-color", "#464866");
      infosvg.append("text")
      .attr("text-anchor", "middle")
      .attr("x", infoWidth / 2)
      .attr("y", infoHeight / 11)
      .text("#" + selected.rank + " " + selected.title.toUpperCase() + " - " + capFirstWord(selected.artist))
      .style("fill", "#AAABB8")
      .style("font-size", "32px");


      infosvg.append("text")
      .attr("text-anchor", "middle")
      .attr("x", infoWidth / 2)
      .attr("y", infoHeight * 3 / 12)
      .text("% unique")
      .style("fill", "#AAABB8")
      .style("font-size", "28px");

      console.log(selected);
      console.log(selected.tiers);


      printSongInfo(infosvg, "Word Count ", selected.wordCount, "#38C4FF", 4/12);
      printSongInfo(infosvg, "Top #1-100 ", selected.tiers[0], "#FEFFFF", 5/12);
      printSongInfo(infosvg, "Top #101-200 ", selected.tiers[1], "#090977", 6/12);
      printSongInfo(infosvg, "Top #201-300 ", selected.tiers[2], "#9f0aad", 7/12);
      printSongInfo(infosvg, "Top #301-400 ", selected.tiers[3], "#ff269c", 8/12);
      printSongInfo(infosvg, "Top #401-500 ", selected.tiers[4], "#05b27b", 9/12);
      printSongInfo(infosvg, "Top #501+ ", selected.tiers[5], "#f73636", 10/12);



      var radius = infoHeight * 0.25;
      var donutWidth = radius / 2;
      var piesvg = d3.select('#info')
          .append('svg')
          .attr('width', infoHeight)
          .attr('height', infoHeight)
          .append('g')
          .attr('transform', 'translate(' + infoHeight / 3 +
            ',' + infoHeight / 2 + ')');

      var arc = d3.arc()
          .innerRadius(radius - donutWidth)
          .outerRadius(radius);
      var pie = d3.pie()
          .value(function(d) { return d; })
          .sort(null);
      var path = piesvg.selectAll('path')
                .data(pie(selected.tiers))
                .enter()
                .append('path')
                .attr('d', arc)
                .attr('fill', function(d, i) {
                  return fillScale(i);
                })
                .attr('id', function(d, i) {
                  return "slice" + i;
                })
                .on("mouseover", function (d) {
                  piesvg.selectAll("path").style("opacity", 0.3);
                  piesvg.selectAll("#slice" + d.index).style("opacity", 1);
                })
                .on("mouseout", function (d) {
                  piesvg.selectAll("path").style("opacity", 1);
                })
                .on("click", function (d) {
                  d3.selectAll(".wordDetails").remove();
                  var w = selected.tierWords;
                  var range = (d.index + 1) * 100;
                  var text;
                  if (d.index != 5) {
                    text = "Top Words #" + (range - 99) + "-" + range;
                  } else {
                    text = "Words not in Top 500";
                  }
                  piesvg.selectAll("path").style("opacity", 1);
                  infosvg.append("text")
                  .attr("text-anchor", "middle")
                  .attr("class", "wordDetails")
                  .attr("x", infoWidth * 0.775)
                  .attr("y", infoHeight * 3 / 11)
                  .text(text)
                  .style("fill", fillScale(d.index))
                  .style("text-decoration", "underline")
                  .style("font-size", "24px");
                  if (d.index == 0) {
                    d3.select("#info").style("background-color", "#c7cccc");
                  } else {
                    d3.select("#info").style("background-color", fillScale(d.index));
                  }
                  d3.selectAll("#info text").style("fill", inverseFillScale(d.index));
                  d3.selectAll("#info tspan").style("fill", inverseFillScale(d.index));
                });
    });

    var simulation = d3.forceSimulation();
    simulation
    .force("x", d3.forceX(d => xScaleMain(d.rank)).strength(1))
    .force("y", d3.forceY(d => yScaleMain(Math.max(d.total, 15))).strength(1))
    .force("collision", d3.forceCollide(d => d.r));

    simulation
    .nodes(wordPoints)
    .on("tick", updateDisplay);

    for (var i = 0; i < 15; ++i) {
      simulation.tick();
    }
    updateDisplay();
    mainsvg.select("#loading").style("opacity", "0");
    mainsvg.selectAll(".mainAxis").style("opacity", "1");
  }

  function printSongInfo (svg, str1, str2, color, pos) {
    svg.append("text")
    .attr("text-anchor", "end")
    .attr("x", infoWidth / 2)
    .attr("y", infoHeight * pos)
    .text(str1)
    .style("fill", "#AAABB8")
    .style("font-size", "22px")
    .style("background-color", color)
    .append('tspan')
    .text(str2)
    .style("fill", color)
    .style("font-size", "26px");
  }

  function capFirstWord(str) {
    return str.split(' ').map(function(w) {
      return w.replace(w[0], w[0].toUpperCase());
    }).join(' ');
  }

	</script>

</body>
</html>
