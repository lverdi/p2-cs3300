<html>
<head>
<title>PROJECT 2</title>
<script src="scripts/d3.js"></script>

<style>
@import
url('https://fonts.googleapis.com/css?family=Raleway:300,400,700,900');

*{
    transition: all ease-in-out 550ms;
}

body {
  background-color: #25274D;
  font-family: 'Raleway', sans-serif;
  color: #AAABB8;
}

h1 {
  display: inline-block;
  vertical-align: middle;
  font-size:5em;
}

circle {
  transition: opacity 600ms;
}

#title {
  width: 80%;
  height: auto;
  margin: auto;
  font-size: 20px;
}

#yearDisplay {
  color: #AAABB8;
  font-size: 24px;
  margin-left: 46%;
}

#yearDisplay span {
  color: #2E9CCA;
  font-size: 32px;
}

#searchBar {
  margin-left: 25%;
  height: 40px;
  width: 10%;
  background: #AAABB8;
  font-size: 20px;
  font-family: 'Raleway', sans-serif;
  border: none;
  padding-left: 5px;
}

#main {
 	padding: 1em;
  border: none;
 	display: inline-block;
 	margin: 0 auto;
  background-color: #464866;
}

.toolbar {
  display: flex;
  align-items: center;
}

.mainAxis {
  font-size: 15px;
  color: white;
  font-family: 'Raleway', sans-serif;
}

.slidecontainer {
    width: 100%;
}

.slider {
    -webkit-appearance: none;
    height: 25px;
    background: #29648A;
    outline: none;
    opacity: 0.7;
    -webkit-transition: .2s;
    transition: opacity .2s;
}

.slider:hover {
    opacity: 1;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    border-radius:25px;
    width: 25px;
    height: 25px;
    background: #38c4ff ;
    cursor: pointer;
}

.slider::-moz-range-thumb {
    border-radius:25px;
    width: 25px;
    height: 25px;
    background: #38c4ff;
    cursor: pointer;
}

</style>
</head>
<body>
	<div id="title" align="center">
		<h1>Lyrics in Popular Songs in the English Language.</h1>
		<p> Analyzing lyrics in the top 100 Billboard songs and their prevalence in the top words of the English language. </p>
	</div>
	<div class="center" align="center">
    <div class="toolbar">
      <h3 id="yearDisplay"> Year: <span>2017</span></h3>
      <input id="searchBar" type="text" placeholder="Search for a word">
    </div>
      <div class = "slidercontainter">
        <input class = "slider" id="slider2" type="range" min="0" max="52" value="52"/>
      </div>

		<svg id="main" width='90%' height='750' align="center"></svg>
	</div>

	</div>
	<script>

  function parseLine (line) {
    var wordArray = line["Lyrics"].split(" ");
    var dict = {};
    for (var i = 0; i < wordArray.length; i++) {
      if (dict[wordArray[i]] == undefined) {
        dict[wordArray[i]] = 1;
      } else {
        dict[wordArray[i]] = dict[wordArray[i]] + 1;
      }
    }
    return {
      Rank: Number(line["Rank"]),
      Title: line["Song"],
      Artist: line["Artist"],
      Year: Number(line["Year"]),
      Lyrics: dict
    };
  }

  var topWords = [];
  d3.text("top1000.txt", function(data) {
    var topWordsPrelim = d3.csvParseRows(data);
    for (var i = 0; i < topWordsPrelim.length; i++) {
      topWords.push(topWordsPrelim[i][0]);
    }
  });

  var graphHeight = document.getElementById("main").clientHeight;
  var graphWidth = document.getElementById("main").clientWidth;
  var axisPadding = 40;
  var currentYear = "2017";
  var nWords = 500;
  var points = [];
  var wordPoints = [];
  var circles;

  var mainsvg = d3.select("#main"),
  g = mainsvg.append("g").attr("transform", "translate(" + 0 + "," + axisPadding  + ")");
  // mainsvg.call(slider1);

  document.getElementById("slider2").style.width = graphWidth;

  mainsvg.append("text")
  .attr("id", "SongName")
  .attr("x", 300)
  .attr("y", 500)
  .style("font-size", "24pt");

  mainsvg.append("text")
  .attr("id", "loading")
  .attr("x", graphWidth / 2)
  .attr("y", graphHeight / 2)
  .attr("text-anchor", "middle")
  .attr("fill", "#AAABB8")
  .style("font-size", "40pt")
  .style("opacity", "1")
  .text("Loading...");

  var xScaleMain = d3.scaleLinear()
  .domain([1, 100])
  .range([axisPadding, graphWidth - axisPadding]);

  var yScaleMain = d3.scaleLinear()
  .domain([15, 90])
  .range([graphHeight - axisPadding, axisPadding]);

  var rScaleTiers = d3.scaleLinear()
  .domain([1, 70])
  .range([3.5, 8]);

  var fillScale = d3.scaleLinear().domain([0, 2, 4, 6, 8, 9]).range(["#FEFFFF", "#3399ff", "#4d52d1", "#a647ff", "#FF008B", "#AAABB8"]);

  mainsvg.append("g")
  .attr("transform", "translate(" + axisPadding / 2  + ", " + 0  + ")")
  .attr("class", "mainAxis")
  .style("opacity", "0")
  .call(YAxis);

  mainsvg.append("g")
  .attr("transform", "translate(0, " + (graphHeight - axisPadding * 2) + ")")
  .attr("class", "mainAxis")
  .style("opacity", "0")
  .call(XAxis);

  function XAxis(g) {
    g.call(d3.axisTop(xScaleMain));
    g.select(".domain").remove();
    g.selectAll(".tick text")
    .attr("fill", "#AAABB8");
  }

  function YAxis(g) {
    g.call(d3.axisLeft(yScaleMain));
    g.select(".domain").remove();
    g.selectAll(".tick:not(:first-of-type) line")
    .attr("stroke", "#AAABB8")
    .attr("stroke-dasharray", "3, 8")
    .attr("x1", graphWidth - axisPadding * 2)
    .attr("x2", -axisPadding / 2);
    g.selectAll(".tick text")
    .attr("fill", "#AAABB8")
    .attr("x", 4)
    .attr("dy", -4);
  }

  function isYear(year) {
      return year.Year === currentYear;
  }

  d3.csv("billboard_lyrics_1964-2017.csv", parseLine, function (error, data) {

    rawData = data;

    nestedData = d3.nest()
    .key(function (d) { return d.Year; })
    .entries(data);

    yearData = nestedData.map(function (year) {
      var result = { Year: year.key, Songs: year.values };
      return result;
    });
    showPointsForYear();
  });

  var slider2 = document.getElementById("slider2");
      slider2.oninput = function () {
        total = parseInt(slider2.value) + 1965;
        currentYear = (total).toString();
        document.getElementById("yearDisplay").innerHTML = "Year: <span>" + currentYear + "</span>";
      };
      slider2.onchange = function () {
        wordPoints = [];
        points = [];
        d3.selectAll("circle").remove();

        total = parseInt(slider2.value) + 1965;
        currentYear = (total).toString();
        document.getElementById("yearDisplay").innerHTML = "Year: <span>" + currentYear + "</span>";
        showPointsForYear();
      };

  var search = document.getElementById("searchBar");
      search.oninput = function () {
        var input = search.value.toLowerCase();
        var pts = d3.selectAll(".wordTiers");
        var songpts = d3.selectAll(".songbubbles");
        if (input == "") {
          pts.style("opacity", 0.9);
          songpts.style("opacity", 0.25);
          songpts.style("fill", "white");
        } else {
          pts.style("opacity", 0.2);
          songpts.style("opacity", 0.15);
          songpts.style("fill", "white");
          var searchResults = [];
          var selectedYear = yearData.find(isYear);
          var yearSongs = selectedYear.Songs;
          var topNWords = topWords.slice(0, nWords);
          for (var i = 0; i < yearSongs.length; i++) {
            var s = yearSongs[i];
            var songLyrics = Object.keys(s.Lyrics);
            for (var j = 0; j < songLyrics.length; j++) {
              var lyric = songLyrics[j];
              if (lyric.includes(input)) {
                document.getElementById("song" + s.Rank).style.fill = "#3399ff";
                document.getElementById("song" + s.Rank).style.opacity = 0.8;
                var idx = topNWords.indexOf(lyric);
                if (idx != -1) {
                  var tier = Math.floor(idx / 50);
                  document.getElementById("tier" + tier + "-" + s.Rank).style.opacity = 1;
                }
              }
            }
          }
        }
      };

  function updateDisplay() {
    circles
    .attr("cx", function(d) { return d.x; })
    .attr("cy", function(d) { return d.y; });
   }

  function showPointsForYear() {
    var topNWords = topWords.slice(0, nWords);
    var selectedYear = yearData.find(isYear);
    var yearSongs = selectedYear.Songs;
    for (var i = 0; i < yearSongs.length; i++) {
      var s = yearSongs[i];
      var tierList = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
      var songLyrics = Object.keys(s.Lyrics);
      var totalWords = 0;
      var uniqueWords = songLyrics.length;
      var uniqueInTop = 0;
      var totalInTop = 0;
      for (var j = 0; j < songLyrics.length; j++) {
        var word = songLyrics[j];
        totalWords += s.Lyrics[word];
        var idx = topNWords.indexOf(word);
        if (idx != -1) {
          tierList[Math.floor(idx / 50)] += s.Lyrics[word];
          uniqueInTop++;
          totalInTop += s.Lyrics[word];
        }
      }
      var uniqueRatio = 100 * uniqueInTop / uniqueWords;
      var totalRatio = 100 * totalInTop / totalWords;

      for (var k = 0; k < tierList.length; k++) {
        if (tierList[k] != 0) {
          wordPoints.push({
            "rank": s.Rank,
            "title": s.Title,
            "r": rScaleTiers(tierList[k]),
            "total": totalRatio,
            "unique": uniqueRatio,
            "tier": k
          });
        }
      }

      points.push({
        "rank": s.Rank,
        "total": totalRatio,
        "totalInTop": totalInTop,
        "unique": uniqueRatio,
        "title": s.Title
      });
    }

    for (var k = 0; k < points.length; k++) {
      var current = points[k];
      var add = 35;
      if (current.totalInTop <= 50) {
        add = 80;
      }
      mainsvg.append("circle")
      .attr("id", "song" + current.rank)
      .attr("class", "songbubbles")
      .attr("r", rScaleTiers(current.totalInTop + add))
      .attr("cx", xScaleMain(current.rank))
      .attr("cy", yScaleMain(Math.max(current.total, 15)))
      .style("fill", "white")
      .style("opacity", 0.25);
    }

    circles = mainsvg.selectAll(".wordTiers").data(wordPoints).enter().append("circle")
    .attr("id", function (d) { return "tier" + d.tier + "-" + d.rank; })
    .attr("r", function (d) { return d.r; })
    .attr("cx", function (d) { return xScaleMain(d.rank); })
    .attr("cy", yScaleMain(50))
    .attr("class", "wordTiers")
    .style("fill", function (d) { return fillScale(d.tier); })
    .style("opacity", 0.9)
    .on("mouseover", function (d) {
      mainsvg.select("#SongName").text(titleCase(d.title));
    });

    var simulation = d3.forceSimulation();
    simulation
    .force("x", d3.forceX(d => xScaleMain(d.rank)).strength(1))
    .force("y", d3.forceY(d => yScaleMain(Math.max(d.total, 15))).strength(1))
    .force("collision", d3.forceCollide(d => d.r));

    simulation
    .nodes(wordPoints)
    .on("tick", updateDisplay);

    for (var i = 0; i < 15; ++i) {
      simulation.tick();
    }
    updateDisplay();
    mainsvg.select("#loading").style("opacity", "0");
    mainsvg.selectAll(".mainAxis").style("opacity", "1");
  }

  function titleCase(str) {
    return str.toLowerCase().split(' ').map(function(word) {
      return word.replace(word[0], word[0].toUpperCase());
    }).join(' ');
  }

	</script>

</body>
</html>
